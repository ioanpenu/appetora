<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Appetora</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e5e7eb;--accent:#ff7a17;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:24px;margin:0}
    .btn{padding:.55rem .9rem;border:1px solid var(--border);border-radius:10px;background:#f8fafc;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea{width:100%;padding:.6rem .7rem;border:1px solid var(--border);border-radius:12px;background:#fff}
    label{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:10px}
    .recipes{display:grid;gap:8px}
    .item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px}
    .muted{color:var(--muted);font-size:12px}
    .pill{font-size:11px;border:1px solid var(--border);padding:.15rem .5rem;border-radius:999px;color:var(--muted)}
    .right{display:flex;gap:6px;align-items:center}
    .hidden{display:none}
    dialog{border:none;border-radius:16px;padding:0;max-width:620px;width:calc(100% - 24px)}
    .dlg{padding:16px}
    .dlg h3{margin:0 0 8px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    /* hero */
    .hero{display:grid;gap:14px;place-items:start;background:linear-gradient(180deg,#fff, #f6f7fb);border:1px solid var(--border);border-radius:18px;padding:24px}
    .hero h2{font-size:28px;margin:0}
    .hero p{margin:0;color:var(--muted)}
    .hero ul{margin:0;padding-left:1.1rem;color:var(--muted)}
    .thumb{width:60px;height:60px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#fff}
    .titleline{display:flex;align-items:center;gap:12px;min-width:0}
    .titleline .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px}
    /* uploader */
    .uploader{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#fff}
    .uploader .preview{display:flex;align-items:center;gap:10px}
    .uploader .preview img{width:96px;height:96px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
    .uploader .actions{display:flex;gap:8px;flex-wrap:wrap}
    video#cam{width:240px;border-radius:12px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Appetora</h1>
      <div class="row" style="gap:10px">
        <div id="authBox" class="row">
          <span id="hello" class="muted hidden">Hi, <b id="helloName"></b></span>
          <button id="btnSignin" class="btn">Sign in</button>
          <button id="btnRegister" class="btn">Register</button>
          <button id="btnLogout" class="btn hidden">Sign out</button>
        </div>
      </div>
    </header>

    <!-- HERO (vizibil numai nelogat) -->
    <section id="hero" class="hero">
      <h2>Your weekly peek. Your daily pick.</h2>
      <p>Plan your week in seconds, avoid repeats, and keep your favorite recipes in one place.</p>
      <ul>
        <li>Add recipes (now with photos)</li>
        <li>Generate a 7-day plan from active recipes</li>
        <li>Pause recipes you don’t want this week</li>
      </ul>
      <div class="row" style="margin-top:6px">
        <button id="ctaRegister" class="btn primary">Create a free account</button>
        <button id="ctaSignin" class="btn">I already have an account</button>
      </div>
    </section>

    <!-- APP (vizibil doar logat) -->
    <section id="app" class="hidden">
      <!-- Add/Edit form -->
      <section class="card grid">
        <h2 style="margin:0">Recipe</h2>
        <div class="row">
          <div style="flex:1">
            <label>Name</label>
            <input id="fName" placeholder="e.g. Pasta Carbonara"/>
          </div>
          <div style="width:280px;max-width:100%">
            <label>Category</label>
            <input id="fCat" placeholder="optional"/>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Ingredients (one per line)</label>
            <textarea id="fIngr" rows="6" placeholder="spaghetti&#10;eggs&#10;bacon&#10;parmesan"></textarea>
          </div>
          <div style="width:360px;max-width:100%">
            <label>Photo</label>
            <div class="uploader">
              <div class="preview">
                <img id="imgPreview" alt="" class="hidden"/>
                <span id="imgLabel" class="muted">No image selected</span>
              </div>
              <div class="actions" style="margin-top:8px">
                <input id="fFile" type="file" accept="image/*" class="hidden"/>
                <button id="btnChoose" class="btn">Choose image</button>
                <button id="btnCamera" class="btn">Take photo</button>
                <button id="btnRemoveImg" class="btn">Remove</button>
              </div>
              <!-- camera area -->
              <div id="camWrap" class="hidden" style="margin-top:10px">
                <video id="cam" autoplay playsinline></video>
                <div class="actions" style="margin-top:8px">
                  <button id="btnSnap" class="btn primary">Capture</button>
                  <button id="btnCloseCam" class="btn">Close camera</button>
                </div>
              </div>
            </div>
            <div class="muted">Images are stored securely in the cloud.</div>
          </div>
        </div>

        <div>
          <label>Instructions</label>
          <textarea id="fInstr" rows="6" placeholder="Steps..."></textarea>
        </div>
        <div class="row">
          <button id="btnSave" class="btn primary">Save to list</button>
          <button id="btnClear" class="btn">Clear</button>
          <span id="formInfo" class="muted"></span>
        </div>
      </section>

      <!-- Actions (plan) -->
      <section class="card grid" style="margin-top:12px">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h2 style="margin:0">Planner</h2>
          <button id="btnPlan" class="btn">Generate weekly plan</button>
        </div>
      </section>

      <!-- List -->
      <section class="card grid" style="margin-top:12px">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h2 style="margin:0">My recipes</h2>
          <span id="count" class="pill">0 recipes</span>
        </div>
        <div id="empty" class="muted">No recipes yet. Add one above.</div>
        <div id="list" class="recipes"></div>
      </section>
    </section>
  </div>

  <!-- Sign in dialog -->
  <dialog id="dlgSignin"><div class="dlg">
    <h3>Sign in</h3>
    <div class="grid">
      <input id="siEmail" placeholder="email"/>
      <input id="siPass" type="password" placeholder="password"/>
      <div class="row">
        <button id="doSignin" class="btn primary">Sign in</button>
        <button class="btn" onclick="dlgSignin.close()">Cancel</button>
      </div>
      <div id="siErr" class="muted"></div>
    </div>
  </div></dialog>

  <!-- Register dialog -->
  <dialog id="dlgRegister"><div class="dlg">
    <h3>Register</h3>
    <div class="grid">
      <input id="reEmail" placeholder="email"/>
      <input id="rePass" type="password" placeholder="password"/>
      <div class="row">
        <button id="doRegister" class="btn primary">Create account</button>
        <button class="btn" onclick="dlgRegister.close()">Cancel</button>
      </div>
      <div id="reErr" class="muted"></div>
    </div>
  </div></dialog>

  <!-- View recipe dialog (read-only) -->
  <dialog id="dlgView"><div class="dlg">
    <div class="titleline">
      <img id="vwImg" class="thumb" alt="" onerror="this.style.display='none'"/>
      <div>
        <h3 id="vwTitle" style="margin:0 0 4px"></h3>
        <div id="vwCat" class="muted"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div>
      <h4 style="margin:.2rem 0">Ingredients</h4>
      <ul id="vwIngr" style="margin:.2rem 0 .6rem 1.2rem"></ul>
    </div>
    <div class="hr"></div>
    <div>
      <h4 style="margin:.2rem 0">Instructions</h4>
      <pre id="vwInstr" style="white-space:pre-wrap;margin:0"></pre>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn" onclick="dlgView.close()">Close</button>
    </div>
  </div></dialog>

  <!-- Weekly plan dialog -->
  <dialog id="dlgPlan"><div class="dlg">
    <h3 style="margin:0 0 8px">Your weekly plan</h3>
    <div id="planErr" class="muted"></div>
    <div class="hr"></div>
    <div style="overflow:auto">
      <table id="planTable">
        <thead><tr><th style="width:140px">Date</th><th>Recipe</th><th style="width:160px">Category</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn" onclick="dlgPlan.close()">Close</button>
    </div>
  </div></dialog>

<script>
const $ = (s)=>document.querySelector(s);
const hero = $('#hero'), app = $('#app');
const listEl = $('#list'), emptyEl = $('#empty'), countEl = $('#count');
const hello = $('#hello'), helloName = $('#helloName');
const btnSignin = $('#btnSignin'), btnRegister = $('#btnRegister'), btnLogout = $('#btnLogout');
const ctaRegister = $('#ctaRegister'), ctaSignin = $('#ctaSignin');
const btnPlan = $('#btnPlan');
const dlgSignin = $('#dlgSignin'), dlgRegister = $('#dlgRegister'), dlgView = $('#dlgView'), dlgPlan = $('#dlgPlan');

const fFile = $('#fFile'), btnChoose = $('#btnChoose'), btnCamera = $('#btnCamera');
const imgPreview = $('#imgPreview'), imgLabel = $('#imgLabel'), btnRemoveImg = $('#btnRemoveImg');
const camWrap = $('#camWrap'), cam = $('#cam'), btnSnap = $('#btnSnap'), btnCloseCam = $('#btnCloseCam');

let currentUser = null;
let editId = null;
let currentBlobPath = null; // imaginea selectată/uploadată pentru form

// cache pentru linkuri de vizualizare (SAS read)
const imageUrlCache = new Map();

async function api(path, opts={}) {
  const res = await fetch(path, { credentials:'include', ...opts });
  const ct = res.headers.get('content-type') || '';
  const body = ct.includes('application/json') ? await res.json() : await res.text();
  return { status: res.status, body };
}

function showApp(loggedIn){
  if (loggedIn) { hero.classList.add('hidden'); app.classList.remove('hidden'); }
  else { app.classList.add('hidden'); hero.classList.remove('hidden'); }
}

async function loadMe() {
  const r = await api('/api/auth/me');
  if (r.status === 200 && r.body && r.body.user) {
    currentUser = r.body.user;
    hello.classList.remove('hidden');
    helloName.textContent = currentUser.name || currentUser.email;
    btnLogout.classList.remove('hidden');
    btnSignin.classList.add('hidden'); btnRegister.classList.add('hidden');
    showApp(true);
    await loadRecipes();
  } else {
    currentUser = null;
    hello.classList.add('hidden');
    btnLogout.classList.add('hidden');
    btnSignin.classList.remove('hidden'); btnRegister.classList.remove('hidden');
    showApp(false);
    renderRecipes([]);
  }
}

async function loadRecipes() {
  const r = await api('/api/recipes');
  if (r.status === 200 && Array.isArray(r.body)) renderRecipes(r.body);
  else renderRecipes([]);
}

async function getImageUrl(blobPath){
  if (!blobPath) return null;
  if (imageUrlCache.has(blobPath)) return imageUrlCache.get(blobPath);
  const r = await api('/api/view-url?blob='+encodeURIComponent(blobPath));
  const url = (r.status===200 && r.body?.url) ? r.body.url : null;
  imageUrlCache.set(blobPath, url);
  return url;
}

async function renderRecipes(items) {
  countEl.textContent = `${items.length} recipe${items.length===1?'':'s'}`;
  if (!items.length) { emptyEl.style.display='block'; listEl.innerHTML=''; return; }
  emptyEl.style.display='none';

  // Rander inițial fără imagini, apoi le completăm asincron
  listEl.innerHTML = items.map(r => `
    <div class="item" data-id="${r.id}">
      <div class="titleline" style="min-width:0">
        <img data-blob="${r.imageBlob||''}" class="thumb ${r.imageBlob?'':'hidden'}" alt=""/>
        <div>
          <div class="name">${esc(r.name)}</div>
          <div class="muted">${esc(r.category || 'No category')} • ${r.ingredients?.length||0} ingredients ${r.paused? ' • ⏸ paused':''}</div>
        </div>
      </div>
      <div class="right">
        <button class="btn" onclick="viewRecipe('${r.id}')">View</button>
        <button class="btn" onclick="editRecipe('${r.id}')">Edit</button>
        <button class="btn" onclick="togglePause('${r.id}', ${!!r.paused})">${r.paused?'Resume':'Pause'}</button>
        <button class="btn" onclick="delRecipe('${r.id}')">Delete</button>
      </div>
    </div>
  `).join('');

  // load imagini
  const imgs = listEl.querySelectorAll('img[data-blob]');
  imgs.forEach(async img=>{
    const blob = img.getAttribute('data-blob');
    if (!blob) return;
    const url = await getImageUrl(blob);
    if (url) { img.src = url; img.classList.remove('hidden'); }
  });
}

function esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])) }

async function saveRecipe() {
  const name = $('#fName').value.trim();
  if (!name) { info('Name required'); return; }
  const payload = {
    id: editId || undefined,
    name,
    category: $('#fCat').value.trim(),
    imageBlob: currentBlobPath || null,
    ingredients: $('#fIngr').value.split('\n').map(s=>s.trim()).filter(Boolean),
    instructions: $('#fInstr').value
  };
  const method = editId ? 'PUT' : 'POST';
  const r = await api('/api/recipes', {
    method, headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (r.status===200 || r.status===201) {
    clearForm(); info(editId?'Updated.':'Saved.');
    await loadRecipes();
  } else {
    info(r.body?.error || 'Error');
  }
}

async function delRecipe(id) {
  if (!confirm('Delete recipe?')) return;
  const r = await api('/api/recipes?id='+encodeURIComponent(id), { method:'DELETE' });
  if (r.status===200) loadRecipes();
}

async function togglePause(id, paused) {
  const r = await api('/api/recipes', {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, paused: !paused })
  });
  if (r.status===200) loadRecipes();
}

async function editRecipe(id) {
  const r = await api('/api/recipes');
  if (r.status!==200) return;
  const rec = (r.body||[]).find(x=>x.id===id);
  if (!rec) return;
  editId = rec.id;
  $('#fName').value = rec.name || '';
  $('#fCat').value = rec.category || '';
  $('#fIngr').value = (rec.ingredients||[]).join('\n');
  $('#fInstr').value = rec.instructions || '';
  currentBlobPath = rec.imageBlob || null;
  await updatePreviewFromBlob(currentBlobPath);
  info('Editing… Save to apply or Clear to cancel.');
}

async function viewRecipe(id) {
  const r = await api('/api/recipes');
  if (r.status !== 200) return;
  const rec = (r.body || []).find(x => x.id === id);
  if (!rec) return;

  const img = document.getElementById('vwImg');
  if (rec.imageBlob) {
    const url = await getImageUrl(rec.imageBlob);
    if (url) { img.src = url; img.style.display='block'; } else { img.removeAttribute('src'); img.style.display='none'; }
  } else { img.removeAttribute('src'); img.style.display='none'; }

  $('#vwTitle').textContent = rec.name || '';
  $('#vwCat').textContent = rec.category ? `Category: ${rec.category}` : 'No category';

  const ul = document.getElementById('vwIngr');
  ul.innerHTML = '';
  (rec.ingredients || []).forEach(it => {
    const li = document.createElement('li');
    li.textContent = String(it);
    ul.appendChild(li);
  });

  document.getElementById('vwInstr').textContent = rec.instructions || '';

  dlgView.showModal();
}

async function generatePlan() {
  const out = await api('/api/plan');
  const errEl = $('#planErr');
  const tbody = document.querySelector('#planTable tbody');
  if (out.status !== 200 || !out.body?.plan) {
    errEl.textContent = out.body?.error || 'Could not generate plan';
    tbody.innerHTML = '';
    dlgPlan.showModal();
    return;
  }
  errEl.textContent = '';
  const rows = out.body.plan.map(p => `
    <tr>
      <td>${esc(p.date)}</td>
      <td>${esc(p.name)}</td>
      <td>${esc(p.category || '')}</td>
    </tr>
  `).join('');
  tbody.innerHTML = rows;
  dlgPlan.showModal();
}

function clearForm(){
  editId = null;
  $('#fName').value=''; $('#fCat').value='';
  $('#fIngr').value=''; $('#fInstr').value='';
  currentBlobPath = null;
  imgPreview.classList.add('hidden'); imgPreview.removeAttribute('src');
  imgLabel.textContent = 'No image selected';
  info('');
}

function info(t){ $('#formInfo').textContent = t; }

/* ---------- Upload logic ---------- */
btnChoose.onclick = ()=> fFile.click();
fFile.onchange = async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  await uploadSelectedFile(file);
};
btnRemoveImg.onclick = ()=>{
  currentBlobPath = null;
  imgPreview.classList.add('hidden'); imgPreview.removeAttribute('src');
  imgLabel.textContent = 'No image selected';
};

/* Camera */
let mediaStream = null;
btnCamera.onclick = async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
    cam.srcObject = mediaStream;
    camWrap.classList.remove('hidden');
  }catch(e){ alert('Camera not available: ' + e.message); }
};
btnCloseCam.onclick = ()=>{
  if (mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream = null;
  camWrap.classList.add('hidden');
};
btnSnap.onclick = async ()=>{
  if (!mediaStream) return;
  const canvas = document.createElement('canvas');
  canvas.width = cam.videoWidth; canvas.height = cam.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(cam, 0, 0);
  canvas.toBlob(async (blob)=>{
    if (!blob) return;
    const file = new File([blob], 'photo.jpg', { type: blob.type || 'image/jpeg' });
    await uploadSelectedFile(file);
    btnCloseCam.click();
  }, 'image/jpeg', 0.9);
};

async function uploadSelectedFile(file){
  info('Uploading image...');
  const up = await api('/api/upload-url', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ filename: file.name || 'image.jpg', contentType: file.type || 'image/jpeg' })
  });
  if (up.status !== 200 || !up.body?.uploadUrl) { info('Could not get upload URL'); return; }

  // PUT direct în blob
  const putRes = await fetch(up.body.uploadUrl, {
    method:'PUT',
    headers:{ 'x-ms-blob-type': 'BlockBlob', 'Content-Type': file.type || 'application/octet-stream' },
    body: file
  });
  if (!putRes.ok) { info('Upload failed'); return; }

  currentBlobPath = up.body.blobPath;
  await updatePreviewFromBlob(currentBlobPath);
  info('Image uploaded.');
}

async function updatePreviewFromBlob(blobPath){
  if (!blobPath) {
    imgPreview.classList.add('hidden'); imgPreview.removeAttribute('src');
    imgLabel.textContent = 'No image selected';
    return;
  }
  const url = await getImageUrl(blobPath);
  if (url){
    imgPreview.src = url; imgPreview.classList.remove('hidden');
    imgLabel.textContent = blobPath.split('/').slice(-1)[0];
  }else{
    imgPreview.classList.add('hidden'); imgLabel.textContent='No image selected';
  }
}

/* ---------- auth & init ---------- */
$('#btnSave').onclick = saveRecipe;
$('#btnClear').onclick = clearForm;
btnPlan.onclick = generatePlan;

btnSignin.onclick = ()=> dlgSignin.showModal();
btnRegister.onclick = ()=> dlgRegister.showModal();
ctaRegister.onclick = ()=> dlgRegister.showModal();
ctaSignin .onclick = ()=> dlgSignin.showModal();

btnLogout.onclick = async ()=>{
  await api('/api/auth/logout', { method:'POST' });
  await loadMe();
};

$('#doSignin').onclick = async ()=>{
  $('#siErr').textContent='';
  const email = $('#siEmail').value.trim(), password = $('#siPass').value;
  const r = await api('/api/auth/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password}) });
  if (r.status===200) { dlgSignin.close(); await loadMe(); }
  else $('#siErr').textContent = r.body?.error || 'Sign in failed';
};

$('#doRegister').onclick = async ()=>{
  $('#reErr').textContent='';
  const email = $('#reEmail').value.trim(), password = $('#rePass').value;
  const r = await api('/api/auth/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password}) });
  if (r.status===200) { dlgRegister.close(); await loadMe(); }
  else $('#reErr').textContent = r.body?.error || 'Register failed';
};

loadMe();
</script>
</body>
</html>
