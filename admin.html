<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Appetora — Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e5e7eb;--accent:#ff7a17;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:.5rem .8rem;border:1px solid var(--border);border-radius:10px;background:#f8fafc;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    input{padding:.55rem .7rem;border:1px solid var(--border);border-radius:10px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    .pill{font-size:11px;border:1px solid var(--border);padding:.15rem .5rem;border-radius:999px;color:var(--muted)}
    .right{display:flex;gap:6px;align-items:center}
    .grid{display:grid;gap:10px}
    .section{display:grid;gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Appetora — Admin</h1>

    <section class="card section">
      <div class="row">
        <input id="adminKey" placeholder="Admin password"/>
        <button id="btnSaveKey" class="btn">Set key</button>
        <span id="keyState" class="muted"></span>
      </div>
      <div class="row">
        <button id="btnRefresh" class="btn primary">Refresh users</button>
        <span id="meta" class="pill">—</span>
      </div>

      <div id="sum" class="muted">Totals will appear here.</div>

      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>User</th>
              <th>Created</th>
              <th>Total imports</th>
              <th>Today</th>
              <th>Last import</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row">
        <input id="day" placeholder="YYYY-MM-DD" style="width:180px"/>
        <button id="btnDay" class="btn">Load day usage</button>
        <span id="dayInfo" class="muted"></span>
      </div>
      <div id="dayOut" class="grid"></div>
    </section>
  </div>

<script>
const $ = s => document.querySelector(s);
const adminKeyInp = $('#adminKey'), keyState = $('#keyState');
const btnSaveKey = $('#btnSaveKey'), btnRefresh = $('#btnRefresh');
const tblBody = document.querySelector('#tbl tbody');
const meta = $('#meta'), sum = $('#sum');
const day = $('#day'), btnDay = $('#btnDay'), dayInfo = $('#dayInfo'), dayOut = $('#dayOut');

function getKey(){ return sessionStorage.getItem('adminKey') || ''; }
function setKey(v){ sessionStorage.setItem('adminKey', v); }

btnSaveKey.onclick = ()=>{
  setKey(adminKeyInp.value.trim());
  keyState.textContent = 'Key saved in session.';
};

async function adminGet(path){
  const res = await fetch(path, {
    headers: { 'x-admin-key': getKey() },
    credentials: 'omit'
  });
  const ct = res.headers.get('content-type')||'';
  const body = ct.includes('application/json') ? await res.json() : await res.text();
  return { status: res.status, body };
}

btnRefresh.onclick = async ()=>{
  keyState.textContent = '';
  const r = await adminGet('/api/admin/users');
  if (r.status !== 200){ keyState.textContent = r.body?.error || 'Auth failed or API error'; return; }
  const rows = (r.body.users||[]).map(u=>{
    return `<tr>
      <td>${esc(u.email)}<div class="muted">${esc(u.name||'')}</div></td>
      <td>${esc(u.createdAt||'')}</td>
      <td>${u.totalImports||0}</td>
      <td>${u.todayImports||0}</td>
      <td>${u.lastImportAt||''}</td>
    </tr>`;
  }).join('');
  tblBody.innerHTML = rows;
  meta.textContent = `${r.body.users?.length||0} users`;
  sum.textContent = `Totals — imports today: ${r.body.totals?.today||0}, all-time imports: ${r.body.totals?.all||0}`;
};

btnDay.onclick = async ()=>{
  const d = day.value.trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(d)){ dayInfo.textContent='Use YYYY-MM-DD'; return; }
  const r = await adminGet('/api/admin/usage?date='+encodeURIComponent(d));
  if (r.status !== 200){ dayInfo.textContent = r.body?.error || 'Error'; return; }
  dayInfo.textContent = `Total imports on ${d}: ${r.body.total||0}`;
  const list = (r.body.items||[]).map(x=>{
    return `<div class="card">
      <div class="right"><b>${esc(x.email||x.uid)}</b> <span class="pill">${x.imports} imports</span></div>
      <div class="muted">uid: ${esc(x.uid)}</div>
    </div>`;
  }).join('');
  dayOut.innerHTML = list || '<div class="muted">No records.</div>';
};

function esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])) }

// init
adminKeyInp.value = getKey();
</script>
</body>
</html>
