<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Appetora ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e5e7eb;--accent:#ff7a17;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:.5rem .8rem;border:1px solid var(--border);border-radius:10px;background:#f8fafc;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    input{padding:.55rem .7rem;border:1px solid var(--border);border-radius:10px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .pill{font-size:11px;border:1px solid var(--border);padding:.15rem .5rem;border-radius:999px;color:var(--muted)}
    .badge{font-size:12px;padding:.15rem .5rem;border-radius:999px;border:1px solid var(--border)}
    .ok{color:#10b981}.warn{color:#f59e0b}.err{color:#ef4444}
    .grid{display:grid;gap:10px}
    .stack{display:grid;gap:6px}
    .danger{background:#fee2e2;border-color:#fecaca}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Appetora ‚Äî Admin</h1>

    <section class="card grid">
      <div class="row">
        <div class="row" style="gap:6px">
          <input id="adminKey" type="password" placeholder="Admin password" style="width:260px"/>
          <button id="togglePw" class="btn" type="button">üëÅÔ∏è</button>
          <button id="btnLogin" class="btn primary" type="button">Sign in</button>
        </div>
        <span id="authState" class="badge">Not signed in</span>
      </div>

      <div class="row">
        <button id="btnRefresh" class="btn" type="button">Refresh users</button>
        <span id="meta" class="pill">‚Äî</span>
      </div>

      <div id="sum" class="muted">Totals will appear here.</div>

      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th style="min-width:220px">User</th>
              <th>Created</th>
              <th>Total imports</th>
              <th>Today</th>
              <th>Last import</th>
              <th>Limit</th>
              <th>Toggle limit</th>
              <th>Admin actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row">
        <input id="day" placeholder="YYYY-MM-DD" style="width:180px"/>
        <button id="btnDay" class="btn" type="button">Load day usage</button>
        <span id="dayInfo" class="muted"></span>
      </div>
      <div id="dayOut" class="grid"></div>
    </section>
  </div>

<script>
const $ = s => document.querySelector(s);
const adminKeyInp = $('#adminKey'), authState = $('#authState');
const btnLogin = $('#btnLogin'), togglePw = $('#togglePw'), btnRefresh = $('#btnRefresh');
const tblBody = document.querySelector('#tbl tbody');
const meta = $('#meta'), sum = $('#sum');
const day = $('#day'), btnDay = $('#btnDay'), dayInfo = $('#dayInfo'), dayOut = $('#dayOut');

function getKey(){ return sessionStorage.getItem('adminKey') || ''; }
function setKey(v){ sessionStorage.setItem('adminKey', v); }
function signedInUI(on){ authState.textContent = on ? 'Signed in' : 'Not signed in'; authState.className = 'badge ' + (on ? 'ok' : ''); }

async function aget(path){
  const res = await fetch(path, { headers: { 'x-admin-key': getKey() }, credentials: 'omit' });
  const ct = res.headers.get('content-type')||''; const body = ct.includes('application/json') ? await res.json() : await res.text();
  return { status: res.status, body };
}
async function apost(path, data){
  const res = await fetch(path, { method:'POST', headers: { 'x-admin-key': getKey(), 'content-type':'application/json' }, body: JSON.stringify(data), credentials:'omit' });
  const ct = res.headers.get('content-type')||''; const body = ct.includes('application/json') ? await res.json() : await res.text();
  return { status: res.status, body };
}
async function adel(path){
  const res = await fetch(path, { method:'DELETE', headers: { 'x-admin-key': getKey() }, credentials:'omit' });
  const ct = res.headers.get('content-type')||''; const body = ct.includes('application/json') ? await res.json() : await res.text();
  return { status: res.status, body };
}

togglePw.onclick = ()=>{ adminKeyInp.type = adminKeyInp.type === 'password' ? 'text' : 'password'; adminKeyInp.focus(); };

btnLogin.onclick = async ()=>{
  const key = adminKeyInp.value.trim(); if (!key){ authState.textContent='Enter password'; authState.className='badge err'; return; }
  setKey(key); authState.textContent='Checking‚Ä¶'; authState.className='badge';
  const r = await aget('/api/adm/ping');
  if (r.status === 200){ signedInUI(true); loadUsers(); }
  else { signedInUI(false); authState.textContent = r.body?.error || 'Wrong password'; authState.className='badge err'; setKey(''); }
};

btnRefresh.onclick = ()=> loadUsers();

async function loadUsers(){
  if (!getKey()){ authState.textContent='Please sign in'; authState.className='badge err'; return; }
  const r = await aget('/api/adm/users');
  if (r.status !== 200){ authState.textContent = r.body?.error || 'Auth failed'; authState.className='badge err'; return; }
  renderUsers(r.body);
}

function renderUsers(data){
  const rows = (data.users||[]).map(u=>{
    const limitTxt = u.noLimit ? '<span class="ok">no limit</span>' : '<span class="warn">5/day</span>';
    const btnTxt = u.noLimit ? 'Disable no-limit' : 'Enable no-limit';
    return `<tr data-uid="${esc(u.id)}" data-nolimit="${u.noLimit?'1':'0'}">
      <td>${esc(u.email)}<div class="muted">${esc(u.name||'')}</div></td>
      <td>${esc(u.createdAt||'')}</td>
      <td>${u.totalImports||0}</td>
      <td>${u.todayImports||0}</td>
      <td>${u.lastImportAt||''}</td>
      <td class="limitCell">${limitTxt}</td>
      <td><button class="btn toggleBtn" type="button">${btnTxt}</button></td>
      <td class="stack">
        <button class="btn resetBtn"  type="button">Reset password</button>
        <button class="btn danger delBtn" type="button">Delete user</button>
      </td>
    </tr>`;
  }).join('');
  tblBody.innerHTML = rows;
  meta.textContent = `${data.users?.length||0} users`;
  sum.textContent  = `Totals ‚Äî imports today: ${data.totals?.today||0}, all-time imports: ${data.totals?.all||0}`;

  // Toggle limit
  tblBody.querySelectorAll('.toggleBtn').forEach(btn=>{
    btn.onclick = async ()=>{
      const tr = btn.closest('tr'); const uid = tr.getAttribute('data-uid');
      const current = tr.getAttribute('data-nolimit') === '1'; const next = !current;
      btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
      const r2 = await apost('/api/adm/limit', { uid, noLimit: next });
      if (r2.status === 200){
        tr.setAttribute('data-nolimit', next?'1':'0');
        tr.querySelector('.limitCell').innerHTML = next ? '<span class="ok">no limit</span>' : '<span class="warn">5/day</span>';
        btn.textContent = next ? 'Disable no-limit' : 'Enable no-limit';
      }else{
        alert(r2.body?.error || 'Error updating limit');
        btn.textContent = current ? 'Disable no-limit' : 'Enable no-limit';
      }
      btn.disabled = false;
    };
  });

  // Reset password
  tblBody.querySelectorAll('.resetBtn').forEach(btn=>{
    btn.onclick = async ()=>{
      const tr = btn.closest('tr'); const uid = tr.getAttribute('data-uid');
      const pass = prompt('New password (min 6 chars):'); if (!pass) return;
      if (pass.length < 6){ alert('Password too short'); return; }
      btn.disabled = true; btn.textContent = 'Resetting‚Ä¶';
      const r = await apost('/api/adm/reset', { uid, newPassword: pass });
      if (r.status === 200) alert('Password reset.');
      else alert(r.body?.error || 'Reset failed');
      btn.disabled = false;
    };
  });

  // Delete user
  tblBody.querySelectorAll('.delBtn').forEach(btn=>{
    btn.onclick = async ()=>{
      const tr = btn.closest('tr'); const uid = tr.getAttribute('data-uid');
      if (!confirm('Delete this user and ALL their data (usage, recipes, history)? This cannot be undone.')) return;
      btn.disabled = true; btn.textContent = 'Deleting‚Ä¶';
      const r = await adel('/api/adm/user?uid='+encodeURIComponent(uid));
      if (r.status === 200){ alert('User deleted.'); loadUsers(); }
      else alert(r.body?.error || 'Delete failed');
      btn.disabled = false;
    };
  });
}

btnDay.onclick = async ()=>{
  if (!getKey()){ authState.textContent='Please sign in'; authState.className='badge err'; return; }
  const d = day.value.trim(); if (!/^\d{4}-\d{2}-\d{2}$/.test(d)){ dayInfo.textContent='Use YYYY-MM-DD'; return; }
  const r = await aget('/api/adm/usage?date='+encodeURIComponent(d));
  if (r.status !== 200){ dayInfo.textContent = r.body?.error || 'Error'; return; }
  dayInfo.textContent = `Total imports on ${d}: ${r.body.total||0}`;
  dayOut.innerHTML = (r.body.items||[]).map(x=>`
    <div class="card">
      <div class="row"><b>${esc(x.email||x.uid)}</b> <span class="pill">${x.imports} imports</span></div>
      <div class="muted">uid: ${esc(x.uid)}</div>
    </div>`).join('') || '<div class="muted">No records.</div>';
};

function esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])) }
adminKeyInp.value = getKey(); signedInUI(!!getKey());
</script>
</body>
</html>
